<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Resource Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .resource-details, .request-details { font-style: italic; color: #666; }
        .admin-controls { margin-bottom: 20px; }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- TensorFlow.js for embeddings -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
    <h1>Admin Resource Management</h1>
    
    <div class="admin-controls">
        <h2>Manage Resources</h2>
        <input type="text" id="resourceName" placeholder="Resource Name">
        <input type="text" id="resourceDetails" placeholder="Resource Details">
        <button onclick="addResource()">Add Resource</button>
        <input type="hidden" id="resourceId">
        <button onclick="updateResource()">Update Resource</button>
    </div>
    
    <h2>Resource and Request Data</h2>
    <table>
        <thead>
            <tr>
                <th>Resource Name</th>
                <th>Resource Details</th>
                <th>Request ID</th>
                <th>Request Details</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="data-table-body"></tbody>
    </table>
    
    <h2>Most Requested Resources</h2>
    <canvas id="requestChart"></canvas>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCXGnKdWdVmi2Z98DCZSYKV_nHx9zH7xRg",
            authDomain: "system-galacticgeeks.firebaseapp.com",
            databaseURL: "https://system-galacticgeeks-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "system-galacticgeeks",
            storageBucket: "system-galacticgeeks.firebasestorage.app",
            messagingSenderId: "835850762785",
            appId: "1:835850762785:web:d2e42efe2422dac089c160",
            measurementId: "G-5S4L5M5GG5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Load TensorFlow.js Universal Sentence Encoder model
        async function loadModel() {
            const model = await tf.loadGraphModel('https://tfhub.dev/google/universal-sentence-encoder/4');
            return model;
        }

        // Generate embeddings for the resource name
        async function getEmbeddings(text) {
            const model = await loadModel();
            const embeddings = await model.executeAsync({ 'input': text });
            return embeddings.arraySync()[0]; // Get the first embedding array
        }

        // Add a new resource with its embedding
        async function addResource() {
            const name = document.getElementById('resourceName').value;
            const details = document.getElementById('resourceDetails').value;

            if (name.trim() === "" || details.trim() === "") {
                alert("Please enter valid resource details.");
                return;
            }

            try {
                const embedding = await getEmbeddings(name); // Get the embedding
                const newResourceRef = db.ref('resources').push();
                newResourceRef.set({ name, details, embedding })
                    .then(() => alert("Resource added successfully!"))
                    .catch(error => console.error("Error adding resource:", error));
            } catch (error) {
                console.error("Error generating embedding:", error);
                alert("Failed to generate embedding.");
            }
        }

        // Update an existing resource
        function updateResource() {
            const resourceId = document.getElementById('resourceId').value;
            const name = document.getElementById('resourceName').value;
            const details = document.getElementById('resourceDetails').value;

            if (resourceId) {
                db.ref(`resources/${resourceId}`).update({ name, details })
                    .then(() => alert("Resource updated successfully!"))
                    .catch(error => console.error("Error updating resource:", error));
            } else {
                alert("No resource selected for update.");
            }
        }

        // Update request status
        function updateStatus(requestId, status, comment) {
            db.ref(`requests/${requestId}`).update({ status: { status, comment } })
                .then(() => alert(`Request ${status.toLowerCase()}`))
                .catch(error => console.error("Error updating status:", error));
        }

        // Delete a resource
        function deleteResource(resourceId) {
            db.ref(`resources/${resourceId}`).remove()
                .then(() => alert("Resource deleted successfully!"))
                .catch(error => console.error("Error deleting resource:", error));
        }

        // Fill the table with resource and request data
        function populateTable(resources, requests) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';

            for (const resourceId in resources) {
                const resource = resources[resourceId];
                const request = requests[resourceId] || {};

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${resource.name}</td>
                    <td class="resource-details">${resource.details}</td>
                    <td>${request ? request.id || 'N/A' : 'N/A'}</td>
                    <td class="request-details">${request.details || ''}</td>
                    <td>${request.status ? request.status.status : 'Pending'}</td>
                    <td>
                        <button onclick="updateStatus('${resourceId}', 'Approved', 'Approved by Admin')">Approve</button>
                        <button onclick="updateStatus('${resourceId}', 'Rejected', 'Rejected by Admin')">Reject</button>
                        <button onclick="deleteResource('${resourceId}')">Delete</button>
                        <button onclick="editResource('${resourceId}', '${resource.name}', '${resource.details}')">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // Reset Form
        function resetForm() {
            document.getElementById('resourceId').value = '';  // Clear Resource ID input
            document.getElementById('resourceName').value = '';
            document.getElementById('resourceDetails').value = '';
            document.getElementById('addResourceBtn').style.display = 'inline-block';
            document.getElementById('updateResourceBtn').style.display = 'none';
        }

        // Delete Resource Function
        function deleteResource(resourceId) {
            db.ref(`resources/${resourceId}`).remove()
                .then(() => alert("Resource deleted successfully"))
                .catch(error => console.error("Error deleting resource:", error));
        }

        // Approve Request Function
        function approveRequest(requestId) {
            const requestRef = db.ref(`requests/${requestId}`);
            requestRef.update({ status: 'Approved' })
                .then(() => {
                    alert("Request approved");
                    updateTable();  // Refresh the table
                })
                .catch(error => console.error("Error approving request:", error));
        }

        // Reject Request Function
        function rejectRequest(requestId) {
            const requestRef = db.ref(`requests/${requestId}`);
            requestRef.update({ status: 'Rejected' })
                .then(() => {
                    alert("Request rejected");
                    updateTable();  // Refresh the table
                })
                .catch(error => console.error("Error rejecting request:", error));
        }

        // Add Comment Function
        function addComment(requestId) {
            const comment = document.getElementById(`comment-${requestId}`).value;
            if (comment.trim() === "") {
                alert("Please enter a comment.");
                return;
            }
            const requestRef = db.ref(`requests/${requestId}`);
            requestRef.update({ comment })
                .then(() => {
                    alert("Comment added");
                    updateTable();  // Refresh the table
                })
                .catch(error => console.error("Error adding comment:", error));
        }

        // Generate Chart Function
        function generateChart(resourceCounts) {
            const ctx = document.getElementById('requestChart').getContext('2d');
            const labels = Object.keys(resourceCounts);
            const data = Object.values(resourceCounts);
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ label: 'Requests', data, backgroundColor: 'blue' }]
                }
            });
        }

        // Real-time data fetching
        db.ref('resources').on('value', (resourcesSnap) => {
            const resources = resourcesSnap.val() || {};
            db.ref('requests').once('value')
                .then((requestsSnap) => {
                    const requests = requestsSnap.val() || {};
                    populateTable(resources, requests);
                    loadChart(requests);
                })
                .catch(error => console.error("Error fetching requests:", error));
        });
    </script>
</body>
</html>
